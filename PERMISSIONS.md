# Система Permissions по ролям

## Обзор

Система permissions реализована на основе ролей пользователей и обеспечивает безопасный доступ к различным частям API.

## Роли пользователей

1. **admin** - Администратор (полный доступ)
2. **director** - Директор (почти полный доступ)
3. **master** - Мастер (доступ к заявкам и данным мастеров)
4. **kc** - КЦ пользователь (ограниченный доступ, в основном чтение)

## Классы Permissions

### IsDirectorOrAdmin
- **Доступ**: Только директоры и администраторы
- **Применение**: Управление городами, типами заявок, РК, пользователями, телефонами городов

### IsMasterOrAbove
- **Доступ**: Мастера, директоры и администраторы
- **Применение**: Расширенные операции с заявками

### IsKCUserOrAbove
- **Доступ**: КЦ пользователи, мастера, директоры и администраторы
- **Применение**: Основные операции с заявками

### IsSameCity
- **Доступ**: Пользователи из того же города + директоры/администраторы
- **Применение**: Фильтрация данных по городам
- **Логика**: Проверяет, что объект принадлежит тому же городу, что и пользователь

### IsOwnerOrSameCity
- **Доступ**: Владелец объекта или пользователи из того же города + директоры/администраторы
- **Применение**: Персональные данные и объекты
- **Логика**: Проверяет владельца или город объекта

### IsReadOnlyForKC
- **Доступ**: КЦ пользователи (только чтение), мастера+ (полный доступ)
- **Применение**: Ограничение операций для КЦ пользователей

### IsMasterOrDirectorForMasterData
- **Доступ**: Мастера, директоры и администраторы
- **Применение**: Данные мастеров

### IsAdminOnly
- **Доступ**: Только администраторы
- **Применение**: Управление ролями

### IsDirectorOrAdminForFinancial
- **Доступ**: Директоры и администраторы
- **Применение**: Финансовые данные (транзакции)

## Применение к ViewSets

### Полный доступ (только директоры/администраторы)
- `GorodViewSet` - Управление городами
- `TipZayavkiViewSet` - Типы заявок
- `RKViewSet` - РК
- `TipTranzakciiViewSet` - Типы транзакций
- `PolzovateliViewSet` - Пользователи
- `PhoneGorodaViewSet` - Телефоны городов
- `RoliViewSet` - Роли (только администраторы)

### Финансовые данные
- `TranzakciiViewSet` - Транзакции (директоры/администраторы + фильтр по городу)

### Данные мастеров
- `MasterViewSet` - Мастера (мастера/директоры + фильтр по городу)

### Заявки
- `ZayavkiViewSet` - Заявки (КЦ+ + фильтр по городу)

## API Views без аутентификации

- `LoginView` - Вход в систему
- `LogoutView` - Выход из системы
- `MeView` - Информация о пользователе (проверка токена вручную)
- `MangoIncomingCallView` - Webhook от Mango

## Аутентификация

Используется кастомный `JWTCookieAuthentication`:
- JWT токены хранятся в HTTP-only cookies
- Автоматическая проверка токенов для всех защищенных эндпоинтов
- Роль пользователя передается в токене

## Обработка ошибок

Кастомный `custom_exception_handler`:
- Структурированные ответы с кодами ошибок
- Понятные сообщения на русском языке
- Правильные HTTP статус коды

## Безопасность

1. **HTTP-only cookies** - защита от XSS
2. **SameSite=Strict** - защита от CSRF
3. **Secure flag** - в продакшене
4. **Фильтрация по городам** - изоляция данных
5. **Проверка ролей** - разграничение доступа
6. **Валидация токенов** - проверка подлинности

## Примеры использования

### Проверка доступа в коде
```python
if request.user.role in ['director', 'admin']:
    # Полный доступ
    pass
elif request.user.role == 'master':
    # Доступ мастера
    pass
elif request.user.role == 'kc':
    # Ограниченный доступ
    pass
```

### Фильтрация по городу
```python
def get_queryset(self):
    queryset = super().get_queryset()
    if self.request.user.role not in ['director', 'admin']:
        queryset = queryset.filter(gorod=self.request.user.gorod)
    return queryset
```

## Рекомендации по развитию

1. Добавить логирование доступа
2. Реализовать кэширование permissions
3. Добавить более детальные permissions (CRUD операции)
4. Создать middleware для автоматической фильтрации
5. Добавить тесты для всех permission классов 